<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Household & Visitors - MEMBRO</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Additional styles for household page */
        .quick-actions .btn {
            cursor: pointer !important;
            pointer-events: auto !important;
            z-index: 1 !important;
        }
        
        /* Stats grid adjustment for 3 cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.25rem;
            }
        }
        
        /* Modal styles to ensure proper display */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        /* Family and Tenant button styles */
        .btn[onclick*="openAddFamily"], 
        .btn[onclick*="openAddTenant"] {
            background: var(--primary) !important;
            border: 2px solid var(--primary) !important;
            color: white !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 10 !important;
        }
        
        .btn[onclick*="openAddFamily"]:hover, 
        .btn[onclick*="openAddTenant"]:hover {
            background: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
            transform: translateY(-2px) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Professional Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon"><img src="logo.png" alt="MEMBRO Logo"></div>
                    <div class="logo-text">
                        <h1>MEMBRO</h1>
                        <span>Your Home Portal</span>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-name">Heriberto Nathan</span>
                        <span class="user-unit">Unit 802</span>
                    </div>
                    <button class="notification-btn" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                    <div class="user-avatar" onclick="toggleUserMenu()">
                        <i class="fas fa-user"></i>
                    </div>
                    <button class="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- User Menu Modal -->
                    <div class="user-menu-modal" id="userMenuModal">
                        <div class="user-menu-panel">
                            <div class="user-menu-header">
                                <div class="user-menu-info">
                                    <div class="user-menu-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="user-menu-details">
                                        <span class="user-menu-name">Heriberto Nathan</span>
                                        <span class="user-menu-unit">Unit 802</span>
                                        <span class="user-menu-email">heriberto.nathan@email.com</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="user-menu-content">
                                <div class="user-menu-section">
                                    <a href="#" class="user-menu-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>Help & Support</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                    <a href="#" class="user-menu-item">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>Privacy Policy</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </div>
                                
                                <div class="user-menu-section">
                                    <button class="user-menu-item logout-btn" onclick="logout()">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Modal -->
                    <div class="notification-modal" id="notificationModal">
                        <div class="notification-overlay" onclick="closeNotifications()"></div>
                        <div class="notification-panel">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="close-btn" onclick="closeNotifications()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="notification-tabs">
                                <button class="tab-btn active" onclick="switchTab('all')">View all</button>
                                <button class="tab-btn" onclick="switchTab('mentions')">Mentions</button>
                            </div>
                            
                            <div class="notification-content">
                                <div class="notification-item" data-type="billing">
                                    <div class="notification-avatar">
                                        <div class="system-avatar">
                                            <i class="fas fa-peso-sign"></i>
                                        </div>
                                    </div>
                                    <div class="notification-body">
                                        <div class="notification-text">
                                            <strong>Payment Reminder</strong>
                                        </div>
                                        <div class="notification-preview">
                                            Your monthly payment of ₱1,250 is due on March 15th
                                        </div>
                                        <div class="notification-time">2 hours ago</div>
                                    </div>
                                    <div class="notification-date">Today</div>
                                </div>
                                
                                <div class="notification-item" data-type="maintenance">
                                    <div class="notification-avatar">
                                        <div class="system-avatar" style="background: var(--warning);">
                                            <i class="fas fa-wrench"></i>
                                        </div>
                                    </div>
                                    <div class="notification-body">
                                        <div class="notification-text">
                                            <strong>Maintenance Update</strong>
                                        </div>
                                        <div class="notification-preview">
                                            Your service request #2024-156 has been completed
                                        </div>
                                        <div class="notification-time">Yesterday</div>
                                    </div>
                                    <div class="notification-date">Sep 19, 2024</div>
                                </div>
                            </div>
                            
                            <div class="notification-footer">
                                <button class="mark-read-btn" onclick="markAllAsRead()">
                                    <i class="fas fa-check-double"></i>
                                    Mark all as read
                                </button>
                                <button class="view-all-btn" onclick="viewAllNotifications()">
                                    View all notifications
                                </button>
                                <a href="notification-settings.html" class="unsubscribe-link">
                                    <i class="fas fa-cog"></i>
                                    Notification Settings
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

         <!-- Desktop Sidebar -->
         <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="announcements.html" class="nav-link">
                        <i class="fas fa-bullhorn"></i>
                        <span>Community News</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="profile.html" class="nav-link">
                        <i class="fas fa-user"></i>
                        <span>My Information</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="properties.html" class="nav-link">
                        <i class="fas fa-key"></i>
                        <span>My Properties</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="household.html" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>My Household</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="billing.html" class="nav-link">
                        <i class="fas fa-credit-card"></i>
                        <span>Bills & Payments</span>
                    </a>
                </li>
              
                <li class="nav-item">
                    <a href="services.html" class="nav-link">
                        <i class="fa fa-calendar"></i>
                        <span>Book Services/Facilities</span>
                    </a>
                </li>
                
                
                <li class="nav-item">
                    <a href="complaints.html" class="nav-link">
                        <i class="fas fa-tools"></i>
                        <span>Request Support</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h2>Household & Visitors</h2>
                <p>Manage your family members, tenants, and visitor access</p>
            </div>

            

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('visitors')" id="visitorsTab">
                    <i class="fas fa-door-open"></i>
                    Visitors
                </button>
                <button class="tab-btn" onclick="showTab('family')" id="familyTab">
                    <i class="fas fa-users"></i>
                    Family Members
                </button>
                <button class="tab-btn" onclick="showTab('tenants')" id="tenantsTab">
                    <i class="fas fa-user-friends"></i>
                    Tenants
                </button>
            </div>

            <!-- Visitors Tab -->
            <div id="visitorsContent" class="tab-content active">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="openExpectedVisitorModal()">
                        <i class="fas fa-user-plus"></i>
                        Add Expected Visitor
                    </button>
                    <button class="btn btn-outline" onclick="exportVisitorLog()">
                        <i class="fas fa-download"></i>
                        Export Log
                    </button>
                </div>

                <!-- Recent Visitors -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clock"></i>
                        Recent Visitors
                        <div class="card-actions">
                            <select class="filter-select" onchange="filterVisitors(this.value)">
                                <option value="all">All Visitors</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="expected">Expected</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="visitor-list" id="visitorList">
                            <!-- Visitor entries will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Family Members Tab -->
            <div id="familyContent" class="tab-content">
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="openAddFamilyModal()">
                        <i class="fas fa-plus"></i>
                        Add Family Member
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-users"></i>
                        Family Members
                    </div>
                    <div class="card-body">
                        <div class="family-grid" id="familyList">
                            <!-- Family members will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tenants Tab -->
            <div id="tenantsContent" class="tab-content">
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="openTenantRequestModal()">
                        <i class="fas fa-file-contract"></i>
                        Request Tenant Application
                    </button>
                    <button class="btn btn-outline" onclick="viewTenantApplications()">
                        <i class="fas fa-list-alt"></i>
                        View Applications
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-user-friends"></i>
                        Active Tenant Applications
                        <div class="card-actions">
                            <select class="filter-select" onchange="filterApplications(this.value)">
                                <option value="all">All Applications</option>
                                <option value="pending">Pending Approval</option>
                                <option value="approved">Approved</option>
                                <option value="active">Currently Active</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="tenant-list" id="tenantList">
                            <!-- Tenant applications will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav-menu">
                <li class="mobile-nav-item">
                    <a href="dashboard.html" class="mobile-nav-link">
                        <i class="fas fa-home"></i>
                        Home
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="profile.html" class="mobile-nav-link">
                        <i class="fas fa-user"></i>
                        Profile
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="announcements.html" class="mobile-nav-link">
                        <i class="fas fa-bullhorn"></i>
                        News
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="billing.html" class="mobile-nav-link">
                        <i class="fas fa-credit-card"></i>
                        Billing
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="services.html" class="mobile-nav-link">
                        <i class="fa fa-calendar"></i>
                        Services
                    </a>
                </li>
                <li class="mobile-nav-item mobile-nav-more">
                    <button class="mobile-nav-link" onclick="toggleMobileMore()">
                        <i class="fas fa-ellipsis-h"></i>
                        More
                    </button>
                    <div class="mobile-nav-dropdown" id="mobileMoreDropdown">
                        <a href="properties.html" class="mobile-nav-dropdown-item">
                            <i class="fas fa-key"></i>
                            Properties
                        </a>
                        <a href="household.html" class="mobile-nav-dropdown-item active">
                            <i class="fas fa-users"></i>
                            Household
                        </a>
                        <a href="complaints.html" class="mobile-nav-dropdown-item">
                            <i class="fas fa-tools"></i>
                            Request Support
                        </a>
                    </div>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Add Family Member Modal -->
    <div class="modal" id="addFamilyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Family Member</div>
                <button class="close-btn" onclick="closeModal('addFamilyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="familyForm" onsubmit="addFamilyMember(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="familyFirstName">First Name</label>
                            <input type="text" id="familyFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="familyLastName">Last Name</label>
                            <input type="text" id="familyLastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="familyRelation">Relationship</label>
                            <select id="familyRelation" class="form-control" required>
                                <option value="">Select relationship...</option>
                                <option value="spouse">Spouse</option>
                                <option value="child">Child</option>
                                <option value="parent">Parent</option>
                                <option value="sibling">Sibling</option>
                                <option value="grandparent">Grandparent</option>
                                <option value="grandchild">Grandchild</option>
                                <option value="other">Other Relative</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="familyAge">Age</label>
                            <input type="number" id="familyAge" class="form-control" min="0" max="120">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="familyPhone">Phone Number</label>
                        <input type="tel" id="familyPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="familyEmail">Email Address</label>
                        <input type="email" id="familyEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="familyPermanent" checked>
                            <label for="familyPermanent">Permanent Resident</label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addFamilyModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Family Member</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tenant Request Application Modal -->
    <div class="modal" id="tenantRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Tenant Request Application</div>
                <button class="close-btn" onclick="closeModal('tenantRequestModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--info-light); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border-left: 4px solid var(--info);">
                    <p style="margin: 0; color: var(--gray-700); font-size: 0.875rem;">
                        <i class="fas fa-info-circle" style="color: var(--info); margin-right: 0.5rem;"></i>
                        This application serves as a request for tenant approval, facilitating a temporary transfer of occupancy rights from the unit owner to the specified tenant for the selected duration. The building administration will validate the applicant's eligibility and required documents before granting final approval.
                    </p>
                </div>
                
                <form id="tenantRequestForm" onsubmit="submitTenantRequest(event)">
                    <div class="form-group">
                        <label for="applicationTitle">Application Title</label>
                        <input type="text" id="applicationTitle" class="form-control" placeholder="e.g., Temporary rental for work assignment" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tenantFirstName">Tenant First Name</label>
                            <input type="text" id="tenantFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="tenantLastName">Tenant Last Name</label>
                            <input type="text" id="tenantLastName" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                    <div class="form-group">
                        <label for="tenantPhone">Phone Number</label>
                        <input type="tel" id="tenantPhone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="tenantEmail">Email Address</label>
                        <input type="email" id="tenantEmail" class="form-control" required>
                    </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ownershipType">Ownership Transfer Type</label>
                        <select id="ownershipType" class="form-control" required onchange="updateOwnershipDescription()">
                            <option value="">Select transfer type...</option>
                            <option value="full_temporary">Full Temporary Ownership</option>
                            <option value="shared_temporary">Shared Temporary Ownership</option>
                            <option value="guest_access">Extended Guest Access</option>
                            <option value="sublease">Authorized Sublease</option>
                        </select>
                        <small id="ownershipDescription" class="form-text" style="color: var(--gray-600); margin-top: 0.5rem;"></small>
                    </div>
                        
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transferStart">Transfer Start Date</label>
                            <input type="date" id="transferStart" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="transferEnd">Transfer End Date</label>
                            <input type="date" id="transferEnd" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                    <div class="form-group">
                            <label for="monthlyCompensation">Monthly Compensation (₱)</label>
                            <input type="number" id="monthlyCompensation" class="form-control" min="0" step="100" placeholder="0">
                            <small class="form-text" style="color: var(--gray-600);">Leave blank or 0 if no compensation</small>
                    </div>
                    <div class="form-group">
                            <label for="securityDeposit">Security Deposit (₱)</label>
                            <input type="number" id="securityDeposit" class="form-control" min="0" step="100" placeholder="0">
                    </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transferReason">Reason for Transfer</label>
                        <textarea id="transferReason" class="form-control" rows="3" placeholder="Please explain why you need to temporarily transfer ownership rights..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalTerms">Additional Terms & Conditions</label>
                        <textarea id="additionalTerms" class="form-control" rows="3" placeholder="Any specific conditions, restrictions, or agreements..."></textarea>
                    </div>
                    
                    <div class="checkbox-wrapper" style="margin: 1.5rem 0;">
                        <input type="checkbox" id="agreeTerms" required>
                        <label for="agreeTerms" style="margin-left: 0.5rem; font-size: 0.875rem;">
                            I understand this application requires admin approval and I agree to the terms of temporary ownership transfer
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('tenantRequestModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Application</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Expected Visitor Modal -->
    <div class="modal" id="expectedVisitorModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Expected Visitor</div>
                <button class="close-btn" onclick="closeModal('expectedVisitorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expectedVisitorForm" onsubmit="addExpectedVisitor(event)">
                    <div class="form-group">
                        <label for="visitorName">Visitor Name</label>
                        <input type="text" id="visitorName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="visitorPhone">Phone Number</label>
                        <input type="tel" id="visitorPhone" class="form-control">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="visitDate">Visit Date</label>
                            <input type="date" id="visitDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="visitTime">Visit Time</label>
                            <input type="time" id="visitTime" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="visitPurpose">Purpose</label>
                        <select id="visitPurpose" class="form-control" required>
                            <option value="personal">Personal</option>
                            <option value="delivery">Delivery</option>
                            <option value="service">Service</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="visitNotes">Notes</label>
                        <textarea id="visitNotes" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('expectedVisitorModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Visitor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add this after the expectedVisitorModal -->
    <div class="modal" id="visitorQRModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Visitor QR Code</div>
                <button class="close-btn" onclick="closeModal('visitorQRModal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;">
                <div id="visitorQRCodeDisplay"></div>
                <div id="qrVisitorDetailsDisplay" style="margin-top:1rem; color:var(--gray-600);"></div>
                <button id="downloadQRBtn2" class="btn btn-primary" style="margin-top:1rem;" onclick="downloadVisitorQR('visitorQRCodeDisplay')">
                    <i class="fas fa-download"></i> Download QR
                </button>
                <div style="margin-top:1.5rem;">
                    <span style="display:block; margin-bottom:0.5rem; color:var(--gray-500); font-size:0.95em;">Share QR via:</span>
                    <button class="btn btn-outline" onclick="shareVisitorQR('gmail', 'visitorQRCodeDisplay')" title="Send via Gmail"><i class="fas fa-envelope"></i> Gmail</button>
                    <button class="btn btn-outline" onclick="shareVisitorQR('whatsapp', 'visitorQRCodeDisplay')" title="Share on WhatsApp"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                    <button class="btn btn-outline" onclick="shareVisitorQR('messenger', 'visitorQRCodeDisplay')" title="Share on Messenger"><i class="fab fa-facebook-messenger"></i> Messenger</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Sample data
        let visitors = [
            {
                id: 1,
                name: "Maria Santos",
                phone: "+63-917-123-4567",
                email: "maria.santos@email.com",
                date: "2024-03-15",
                time: "14:30",
                purpose: "personal",
                status: "expected",
                notes: "Sister visiting for the weekend"
            },
            {
                id: 2,
                name: "Juan Delivery",
                phone: "+63-917-765-4321",
                email: "",
                date: "2024-03-14",
                time: "10:15",
                purpose: "delivery",
                status: "completed",
                notes: "LBC package delivery"
            },
            {
                id: 3,
                name: "Dr. Roberto Cruz",
                phone: "+63-917-888-9999",
                email: "dr.cruz@medical.com",
                date: "2024-03-13",
                time: "16:00",
                purpose: "service",
                status: "completed",
                notes: "Home consultation"
            }
        ];

        let familyMembers = [
            {
                id: 1,
                firstName: "Isabel",
                lastName: "Nathan",
                relation: "spouse",
                age: 32,
                phone: "+63-917-111-2222",
                email: "isabel.nathan@email.com",
                permanent: true
            },
            {
                id: 2,
                firstName: "Miguel",
                lastName: "Nathan",
                relation: "child",
                age: 8,
                phone: "",
                email: "",
                permanent: true
            },
            {
                id: 3,
                firstName: "Sofia",
                lastName: "Nathan",
                relation: "child",
                age: 5,
                phone: "",
                email: "",
                permanent: true
            },
            {
                id: 4,
                firstName: "Carmen",
                lastName: "Rodriguez",
                relation: "parent",
                age: 65,
                phone: "+63-917-333-4444",
                email: "carmen.rodriguez@email.com",
                permanent: false
            }
        ];

        let tenantApplications = [
            {
                id: 1,
                applicationTitle: "Business Trip Extended Stay",
                firstName: "Ana",
                lastName: "Reyes",
                phone: "+63-917-555-6666",
                email: "ana.reyes@email.com",
                ownershipType: "full_temporary",
                transferStart: "2024-01-01",
                transferEnd: "2024-12-31",
                monthlyCompensation: 8000,
                securityDeposit: 16000,
                transferReason: "Extended business trip requires temporary rental of unit",
                additionalTerms: "Guest room access only, shared common areas",
                status: "active",
                submittedDate: "2023-12-15",
                approvedDate: "2023-12-20"
            },
            {
                id: 2,
                applicationTitle: "Student Accommodation Request",
                firstName: "Carlos",
                lastName: "Martinez",
                phone: "+63-917-777-8888",
                email: "carlos.martinez@email.com",
                ownershipType: "shared_temporary",
                transferStart: "2024-02-15",
                transferEnd: "2024-08-15",
                monthlyCompensation: 6000,
                securityDeposit: 12000,
                transferReason: "Student needs temporary accommodation during semester",
                additionalTerms: "Study room access, shared utilities",
                status: "active",
                submittedDate: "2024-01-10",
                approvedDate: "2024-02-01"
            },
            {
                id: 3,
                applicationTitle: "Family Visit Extended Stay",
                firstName: "Maria",
                lastName: "Santos",
                phone: "+63-917-999-0000",
                email: "maria.santos@email.com",
                ownershipType: "guest_access",
                transferStart: "2024-04-01",
                transferEnd: "2024-06-30",
                monthlyCompensation: 0,
                securityDeposit: 5000,
                transferReason: "Elderly family member needs temporary care and accommodation",
                additionalTerms: "No compensation required, family assistance arrangement",
                status: "pending",
                submittedDate: "2024-03-10",
                approvedDate: null
            }
        ];

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load content based on tab
            if (tabName === 'visitors') {
                loadVisitors();
            } else if (tabName === 'family') {
                loadFamilyMembers();
            } else if (tabName === 'tenants') {
                loadTenantApplications();
            }
        }

        // Visitor Management
        function loadVisitors() {
            const visitorList = document.getElementById('visitorList');
            visitorList.innerHTML = '';

            visitors.forEach(visitor => {
                const statusClass = visitor.status === 'expected' ? 'status-warning' : 'status-success';
                const statusText = visitor.status === 'expected' ? 'Expected' : 'Completed';
                
                const visitorCard = `
                    <div class="visitor-card">
                        <div class="visitor-info">
                            <div class="visitor-header">
                                <h4>${visitor.name}</h4>
                                <span class="visitor-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="visitor-details">
                                <div class="detail-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${visitor.phone}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${visitor.date} at ${visitor.time}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clipboard"></i>
                                    <span>${visitor.purpose.charAt(0).toUpperCase() + visitor.purpose.slice(1)}</span>
                                </div>
                                ${visitor.notes ? `<div class="detail-item"><i class="fas fa-sticky-note"></i><span>${visitor.notes}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="visitor-actions">
                            <button class="btn btn-sm btn-outline" onclick="editVisitor(${visitor.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeVisitor(${visitor.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                visitorList.innerHTML += visitorCard;
            });
        }

        // Family Management
        function loadFamilyMembers() {
            const familyList = document.getElementById('familyList');
            familyList.innerHTML = '';

            familyMembers.forEach(member => {
                const memberCard = `
                    <div class="family-card">
                        <div class="family-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="family-info">
                            <h4>${member.firstName} ${member.lastName}</h4>
                            <p class="family-relation">${member.relation.charAt(0).toUpperCase() + member.relation.slice(1)}</p>
                            ${member.age ? `<p class="family-age">Age: ${member.age}</p>` : ''}
                            ${member.phone ? `<p class="family-contact"><i class="fas fa-phone"></i> ${member.phone}</p>` : ''}
                            ${member.email ? `<p class="family-contact"><i class="fas fa-envelope"></i> ${member.email}</p>` : ''}
                            <span class="family-status ${member.permanent ? 'permanent' : 'temporary'}">
                                ${member.permanent ? 'Permanent' : 'Temporary'}
                            </span>
                        </div>
                        <div class="family-actions">
                            <button class="btn btn-sm btn-outline" onclick="editFamilyMember(${member.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeFamilyMember(${member.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                familyList.innerHTML += memberCard;
            });
        }

        // Tenant Application Management
        function loadTenantApplications() {
            const tenantList = document.getElementById('tenantList');
            tenantList.innerHTML = '';

            tenantApplications.forEach(application => {
                const transferEndDate = new Date(application.transferEnd);
                const today = new Date();
                const daysRemaining = Math.ceil((transferEndDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass, statusText, timeText;
                if (application.status === 'pending') {
                    statusClass = 'status-warning';
                    statusText = 'Pending Approval';
                    timeText = `Submitted: ${application.submittedDate}`;
                } else if (application.status === 'approved') {
                    statusClass = 'status-success';
                    statusText = 'Approved';
                    timeText = `Starts: ${application.transferStart}`;
                } else if (application.status === 'active') {
                    statusClass = daysRemaining < 30 ? 'status-warning' : 'status-success';
                    statusText = 'Currently Active';
                    timeText = `${daysRemaining} days remaining`;
                } else {
                    statusClass = 'status-danger';
                    statusText = 'Expired';
                    timeText = `Ended: ${application.transferEnd}`;
                }

                const ownershipTypeText = {
                    'full_temporary': 'Full Temporary Ownership',
                    'shared_temporary': 'Shared Temporary Ownership',
                    'guest_access': 'Extended Guest Access',
                    'sublease': 'Authorized Sublease'
                };
                
                const applicationCard = `
                    <div class="tenant-card">
                        <div class="tenant-info">
                            <div class="tenant-header">
                                <h4>${application.firstName} ${application.lastName}</h4>
                                <span class="application-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="application-title">
                                <strong>${application.applicationTitle}</strong>
                            </div>
                            <div class="tenant-details">
                                <div class="detail-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${application.phone}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>${application.email}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-file-contract"></i>
                                    <span>${ownershipTypeText[application.ownershipType]}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Transfer: ${application.transferStart} to ${application.transferEnd}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <span class="${statusClass}">${timeText}</span>
                                </div>
                                ${application.monthlyCompensation > 0 ? `<div class="detail-item"><i class="fas fa-peso-sign"></i><span>₱${application.monthlyCompensation.toLocaleString()}/month</span></div>` : ''}
                                <div class="detail-item">
                                    <i class="fas fa-info-circle"></i>
                                    <span>${application.transferReason}</span>
                                </div>
                            </div>
                        </div>
                        <div class="tenant-actions">
                            <button class="btn btn-sm btn-outline" onclick="viewApplicationDetails(${application.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${application.status === 'pending' ? `<button class="btn btn-sm btn-outline" onclick="editApplication(${application.id})" title="Edit Application"><i class="fas fa-edit"></i></button>` : ''}
                            ${application.status === 'pending' ? `<button class="btn btn-sm btn-danger" onclick="cancelApplication(${application.id})" title="Cancel Application"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                `;
                
                tenantList.innerHTML += applicationCard;
            });
        }

        // Edit and Remove Functions
        function editVisitor(id) {
            const visitor = visitors.find(v => v.id === id);
            if (visitor) {
                // Populate the form with existing data
                document.getElementById('visitorName').value = visitor.name;
                document.getElementById('visitorPhone').value = visitor.phone;
                document.getElementById('visitorEmail').value = visitor.email || '';
                document.getElementById('visitDate').value = visitor.date;
                document.getElementById('visitTime').value = visitor.time;
                document.getElementById('visitPurpose').value = visitor.purpose;
                document.getElementById('visitNotes').value = visitor.notes || '';
                
                // Store the ID for updating
                document.getElementById('visitorForm').setAttribute('data-edit-id', id);
                
                // Change form title and button text
                document.querySelector('#addVisitorModal .modal-title').textContent = 'Edit Visitor';
                document.querySelector('#addVisitorModal button[type="submit"]').textContent = 'Update Visitor';
                
                openAddVisitorModal();
            }
        }

        function removeVisitor(id) {
            if (confirm('Are you sure you want to remove this visitor?')) {
                const index = visitors.findIndex(v => v.id === id);
                if (index > -1) {
                    visitors.splice(index, 1);
                    loadVisitors();
                    showToast('Visitor removed successfully!');
                }
            }
        }

        function editFamilyMember(id) {
            const member = familyMembers.find(m => m.id === id);
            if (member) {
                // Populate the form with existing data
                document.getElementById('familyFirstName').value = member.firstName;
                document.getElementById('familyLastName').value = member.lastName;
                document.getElementById('familyRelation').value = member.relation;
                document.getElementById('familyAge').value = member.age || '';
                document.getElementById('familyPhone').value = member.phone || '';
                document.getElementById('familyEmail').value = member.email || '';
                document.getElementById('familyPermanent').checked = member.permanent;
                
                // Store the ID for updating
                document.getElementById('familyForm').setAttribute('data-edit-id', id);
                
                // Change form title and button text
                document.querySelector('#addFamilyModal .modal-title').textContent = 'Edit Family Member';
                document.querySelector('#addFamilyModal button[type="submit"]').textContent = 'Update Member';
                
                openAddFamilyModal();
            }
        }

        function removeFamilyMember(id) {
            if (confirm('Are you sure you want to remove this family member?')) {
                const index = familyMembers.findIndex(m => m.id === id);
                if (index > -1) {
                    familyMembers.splice(index, 1);
                    loadFamilyMembers();
                    showToast('Family member removed successfully!');
                }
            }
        }

        function editTenant(id) {
            const tenant = tenants.find(t => t.id === id);
            if (tenant) {
                // Populate the form with existing data
                document.getElementById('tenantFirstName').value = tenant.firstName;
                document.getElementById('tenantLastName').value = tenant.lastName;
                document.getElementById('tenantPhone').value = tenant.phone;
                document.getElementById('tenantEmail').value = tenant.email;
                document.getElementById('leaseStart').value = tenant.leaseStart;
                document.getElementById('leaseEnd').value = tenant.leaseEnd;
                document.getElementById('monthlyRent').value = tenant.monthlyRent;
                document.getElementById('tenantNotes').value = tenant.notes || '';
                
                // Store the ID for updating
                document.getElementById('tenantForm').setAttribute('data-edit-id', id);
                
                // Change form title and button text
                document.querySelector('#addTenantModal .modal-title').textContent = 'Edit Tenant';
                document.querySelector('#addTenantModal button[type="submit"]').textContent = 'Update Tenant';
                
                openAddTenantModal();
            }
        }

        function removeTenant(id) {
            if (confirm('Are you sure you want to remove this tenant?')) {
                const index = tenants.findIndex(t => t.id === id);
                if (index > -1) {
                    tenants.splice(index, 1);
                    loadTenants();
                    showToast('Tenant removed successfully!');
                }
            }
        }

        // Filter and Search Functions
        function filterVisitors(filterType) {
            const visitorList = document.getElementById('visitorList');
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekAgoString = weekAgo.toISOString().split('T')[0];

            let filteredVisitors = visitors;

            switch (filterType) {
                case 'today':
                    filteredVisitors = visitors.filter(v => v.date === today);
                    break;
                case 'week':
                    filteredVisitors = visitors.filter(v => v.date >= weekAgoString);
                    break;
                case 'expected':
                    filteredVisitors = visitors.filter(v => v.status === 'expected');
                    break;
                default:
                    filteredVisitors = visitors;
            }

            // Clear and rebuild the visitor list
            visitorList.innerHTML = '';
            filteredVisitors.forEach(visitor => {
                const statusClass = visitor.status === 'expected' ? 'status-warning' : 'status-success';
                const statusText = visitor.status === 'expected' ? 'Expected' : 'Completed';
                
                const visitorCard = `
                    <div class="visitor-card">
                        <div class="visitor-info">
                            <div class="visitor-header">
                                <h4>${visitor.name}</h4>
                                <span class="visitor-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="visitor-details">
                                <div class="detail-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${visitor.phone}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${visitor.date} at ${visitor.time}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clipboard"></i>
                                    <span>${visitor.purpose.charAt(0).toUpperCase() + visitor.purpose.slice(1)}</span>
                                </div>
                                ${visitor.notes ? `<div class="detail-item"><i class="fas fa-sticky-note"></i><span>${visitor.notes}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="visitor-actions">
                            <button class="btn btn-sm btn-outline" onclick="editVisitor(${visitor.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeVisitor(${visitor.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                visitorList.innerHTML += visitorCard;
            });

            if (filteredVisitors.length === 0) {
                visitorList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">No visitors found for the selected filter.</div>';
            }
        }

        // Bulk Operations
        function exportVisitorLog() {
            // Create CSV content
            let csvContent = "Date,Name,Phone,Email,Time,Purpose,Status,Notes\n";
            
            visitors.forEach(visitor => {
                const row = [
                    visitor.date,
                    `"${visitor.name}"`,
                    visitor.phone,
                    visitor.email || '',
                    visitor.time,
                    visitor.purpose,
                    visitor.status,
                    `"${visitor.notes || ''}"`
                ].join(',');
                csvContent += row + '\n';
            });

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `visitor_log_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            showToast('Visitor log exported successfully!');
        }

        // Modal Management - Enhanced with debugging
        function openAddFamilyModal() {
            console.log('openAddFamilyModal called'); // Debug log
            
            // Reset form and modal state
            document.getElementById('familyForm').removeAttribute('data-edit-id');
            document.querySelector('#addFamilyModal .modal-title').textContent = 'Add Family Member';
            document.querySelector('#addFamilyModal button[type="submit"]').textContent = 'Add Family Member';
            
            const modal = document.getElementById('addFamilyModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Family modal opened'); // Debug log
            } else {
                console.error('Family modal not found'); // Debug log
            }
        }

        function openTenantRequestModal() {
            console.log('openTenantRequestModal called'); // Debug log
            
            // Reset form and modal state
            document.getElementById('tenantRequestForm').removeAttribute('data-edit-id');
            document.querySelector('#tenantRequestModal .modal-title').textContent = 'Tenant Request Application';
            document.querySelector('#tenantRequestModal button[type="submit"]').textContent = 'Submit Application';
            
            // Set minimum dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transferStart').min = today;
            document.getElementById('transferEnd').min = today;
            
            const modal = document.getElementById('tenantRequestModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Tenant request modal opened'); // Debug log
            } else {
                console.error('Tenant request modal not found'); // Debug log
            }
        }

        // Enhanced closeModal to work for all modals
        function closeModal(modalId) {
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
            // Reset forms if needed
            if (modalId === 'addFamilyModal') {
                document.getElementById('familyForm').reset();
                document.getElementById('familyForm').removeAttribute('data-edit-id');
            } else if (modalId === 'tenantRequestModal') {
                document.getElementById('tenantRequestForm').reset();
                document.getElementById('tenantRequestForm').removeAttribute('data-edit-id');
            } else if (modalId === 'expectedVisitorModal') {
                document.getElementById('expectedVisitorForm').reset();
            }
        }

        // Enhanced Form Submissions
        function addFamilyMember(event) {
            event.preventDefault();
            
            const form = document.getElementById('familyForm');
            const editId = form.getAttribute('data-edit-id');
            
            const memberData = {
                firstName: document.getElementById('familyFirstName').value,
                lastName: document.getElementById('familyLastName').value,
                relation: document.getElementById('familyRelation').value,
                age: parseInt(document.getElementById('familyAge').value) || null,
                phone: document.getElementById('familyPhone').value,
                email: document.getElementById('familyEmail').value,
                permanent: document.getElementById('familyPermanent').checked
            };
            
            if (editId) {
                // Update existing family member
                const index = familyMembers.findIndex(m => m.id == editId);
                if (index > -1) {
                    familyMembers[index] = { ...familyMembers[index], ...memberData };
                    showToast('Family member updated successfully!');
                }
            } else {
                // Add new family member
                const newMember = {
                    id: Math.max(...familyMembers.map(m => m.id), 0) + 1,
                    ...memberData
                };
                familyMembers.push(newMember);
                showToast('Family member added successfully!');
            }
            
            loadFamilyMembers();
            closeModal('addFamilyModal');
        }

        // Tenant Application Management Functions
        function submitTenantRequest(event) {
            event.preventDefault();
            
            const form = document.getElementById('tenantRequestForm');
            const editId = form.getAttribute('data-edit-id');
            
            const applicationData = {
                applicationTitle: document.getElementById('applicationTitle').value,
                firstName: document.getElementById('tenantFirstName').value,
                lastName: document.getElementById('tenantLastName').value,
                phone: document.getElementById('tenantPhone').value,
                email: document.getElementById('tenantEmail').value,
                ownershipType: document.getElementById('ownershipType').value,
                transferStart: document.getElementById('transferStart').value,
                transferEnd: document.getElementById('transferEnd').value,
                monthlyCompensation: parseInt(document.getElementById('monthlyCompensation').value) || 0,
                securityDeposit: parseInt(document.getElementById('securityDeposit').value) || 0,
                transferReason: document.getElementById('transferReason').value,
                additionalTerms: document.getElementById('additionalTerms').value,
                status: 'pending',
                submittedDate: new Date().toISOString().split('T')[0],
                approvedDate: null
            };
            
            if (editId) {
                // Update existing application
                const index = tenantApplications.findIndex(t => t.id == editId);
                if (index > -1) {
                    tenantApplications[index] = { ...tenantApplications[index], ...applicationData };
                    showToast('Tenant application updated successfully!');
                }
            } else {
                // Add new application
                const newApplication = {
                    id: Math.max(...tenantApplications.map(t => t.id), 0) + 1,
                    ...applicationData
                };
                tenantApplications.push(newApplication);
                showToast('Tenant application submitted successfully! Awaiting admin approval.');
            }
            
            loadTenantApplications();
            closeModal('tenantRequestModal');
        }

        // Update ownership description based on selection
        function updateOwnershipDescription() {
            const ownershipType = document.getElementById('ownershipType').value;
            const description = document.getElementById('ownershipDescription');
            
            const descriptions = {
                'full_temporary': 'Complete temporary ownership transfer. Tenant will have full access and responsibilities for the unit during the specified period.',
                'shared_temporary': 'Shared ownership arrangement. Both owner and tenant will have access and shared responsibilities.',
                'guest_access': 'Extended guest privileges. Tenant will have living access but limited ownership rights.',
                'sublease': 'Authorized subletting arrangement. Tenant becomes temporary lessee under your ownership.'
            };
            
            description.textContent = descriptions[ownershipType] || '';
        }

        // New functions for tenant application management
        function viewApplicationDetails(id) {
            const application = tenantApplications.find(app => app.id === id);
            if (application) {
                const ownershipTypeText = {
                    'full_temporary': 'Full Temporary Ownership',
                    'shared_temporary': 'Shared Temporary Ownership',
                    'guest_access': 'Extended Guest Access',
                    'sublease': 'Authorized Sublease'
                };
                
                alert(`Application Details:
Title: ${application.applicationTitle}
Applicant: ${application.firstName} ${application.lastName}
Contact: ${application.phone} | ${application.email}
Type: ${ownershipTypeText[application.ownershipType]}
Period: ${application.transferStart} to ${application.transferEnd}
Compensation: ₱${application.monthlyCompensation}/month
Security Deposit: ₱${application.securityDeposit}
Status: ${application.status.toUpperCase()}
Reason: ${application.transferReason}
${application.additionalTerms ? `Additional Terms: ${application.additionalTerms}` : ''}`);
            }
        }

        function editApplication(id) {
            const application = tenantApplications.find(app => app.id === id);
            if (application && application.status === 'pending') {
                // Populate the form with existing data
                document.getElementById('applicationTitle').value = application.applicationTitle;
                document.getElementById('tenantFirstName').value = application.firstName;
                document.getElementById('tenantLastName').value = application.lastName;
                document.getElementById('tenantPhone').value = application.phone;
                document.getElementById('tenantEmail').value = application.email;
                document.getElementById('ownershipType').value = application.ownershipType;
                document.getElementById('transferStart').value = application.transferStart;
                document.getElementById('transferEnd').value = application.transferEnd;
                document.getElementById('monthlyCompensation').value = application.monthlyCompensation;
                document.getElementById('securityDeposit').value = application.securityDeposit;
                document.getElementById('transferReason').value = application.transferReason;
                document.getElementById('additionalTerms').value = application.additionalTerms;
                
                // Update ownership description
                updateOwnershipDescription();
                
                // Store the ID for updating
                document.getElementById('tenantRequestForm').setAttribute('data-edit-id', id);
                
                // Change form title and button text
                document.querySelector('#tenantRequestModal .modal-title').textContent = 'Edit Tenant Application';
                document.querySelector('#tenantRequestModal button[type="submit"]').textContent = 'Update Application';
                
                openTenantRequestModal();
            } else {
                showToast('Only pending applications can be edited.');
            }
        }

        function cancelApplication(id) {
            if (confirm('Are you sure you want to cancel this tenant application? This action cannot be undone.')) {
                const index = tenantApplications.findIndex(app => app.id === id);
                if (index > -1) {
                    tenantApplications.splice(index, 1);
                    loadTenantApplications();
                    showToast('Tenant application cancelled successfully!');
                }
            }
        }

        function viewTenantApplications() {
            // Show all applications by resetting filter
            document.querySelector('.filter-select').value = 'all';
            loadTenantApplications();
            showToast('Showing all tenant applications');
        }

        function filterApplications(filterType) {
            const tenantList = document.getElementById('tenantList');
            let filteredApplications = tenantApplications;

            switch (filterType) {
                case 'pending':
                    filteredApplications = tenantApplications.filter(app => app.status === 'pending');
                    break;
                case 'approved':
                    filteredApplications = tenantApplications.filter(app => app.status === 'approved');
                    break;
                case 'active':
                    filteredApplications = tenantApplications.filter(app => app.status === 'active');
                    break;
                case 'expired':
                    const today = new Date();
                    filteredApplications = tenantApplications.filter(app => new Date(app.transferEnd) < today);
                    break;
                default:
                    filteredApplications = tenantApplications;
            }

            // Rebuild the list with filtered applications
            tenantList.innerHTML = '';
            
            filteredApplications.forEach(application => {
                const transferEndDate = new Date(application.transferEnd);
                const today = new Date();
                const daysRemaining = Math.ceil((transferEndDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass, statusText, timeText;
                if (application.status === 'pending') {
                    statusClass = 'status-warning';
                    statusText = 'Pending Approval';
                    timeText = `Submitted: ${application.submittedDate}`;
                } else if (application.status === 'approved') {
                    statusClass = 'status-success';
                    statusText = 'Approved';
                    timeText = `Starts: ${application.transferStart}`;
                } else if (application.status === 'active') {
                    statusClass = daysRemaining < 30 ? 'status-warning' : 'status-success';
                    statusText = 'Currently Active';
                    timeText = `${daysRemaining} days remaining`;
                } else {
                    statusClass = 'status-danger';
                    statusText = 'Expired';
                    timeText = `Ended: ${application.transferEnd}`;
                }

                const ownershipTypeText = {
                    'full_temporary': 'Full Temporary Ownership',
                    'shared_temporary': 'Shared Temporary Ownership',
                    'guest_access': 'Extended Guest Access',
                    'sublease': 'Authorized Sublease'
                };
                
                const applicationCard = `
                    <div class="tenant-card">
                        <div class="tenant-info">
                            <div class="tenant-header">
                                <h4>${application.firstName} ${application.lastName}</h4>
                                <span class="application-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="application-title">
                                <strong>${application.applicationTitle}</strong>
                            </div>
                            <div class="tenant-details">
                                <div class="detail-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${application.phone}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>${application.email}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-file-contract"></i>
                                    <span>${ownershipTypeText[application.ownershipType]}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Transfer: ${application.transferStart} to ${application.transferEnd}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <span class="${statusClass}">${timeText}</span>
                                </div>
                                ${application.monthlyCompensation > 0 ? `<div class="detail-item"><i class="fas fa-peso-sign"></i><span>₱${application.monthlyCompensation.toLocaleString()}/month</span></div>` : ''}
                                <div class="detail-item">
                                    <i class="fas fa-info-circle"></i>
                                    <span>${application.transferReason}</span>
                                </div>
                            </div>
                        </div>
                        <div class="tenant-actions">
                            <button class="btn btn-sm btn-outline" onclick="viewApplicationDetails(${application.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${application.status === 'pending' ? `<button class="btn btn-sm btn-outline" onclick="editApplication(${application.id})" title="Edit Application"><i class="fas fa-edit"></i></button>` : ''}
                            ${application.status === 'pending' ? `<button class="btn btn-sm btn-danger" onclick="cancelApplication(${application.id})" title="Cancel Application"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                `;
                
                tenantList.innerHTML += applicationCard;
            });

            if (filteredApplications.length === 0) {
                tenantList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">No applications found for the selected filter.</div>';
            }
        }

        // Utility Functions
        function showToast(message) {
            // Create and show toast notification
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--secondary);
                color: white;
                padding: 1rem 2rem;
                border-radius: var(--radius-md);
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.opacity = '1', 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Header Functions
        function toggleUserMenu() {
            const modal = document.getElementById('userMenuModal');
            modal.classList.toggle('active');
        }

        function toggleNotifications() {
            const modal = document.getElementById('notificationModal');
            modal.classList.toggle('active');
        }

        function closeNotifications() {
            const modal = document.getElementById('notificationModal');
            modal.classList.remove('active');
        }

        function markAllAsRead() {
            const notifications = document.querySelectorAll('.notification-item.unread');
            notifications.forEach(notification => {
                notification.classList.remove('unread');
            });
            
            // Update notification badge
            const badge = document.querySelector('.notification-badge');
            if (badge) {
                badge.textContent = '0';
                badge.style.display = 'none';
            }
            
            showToast('All notifications marked as read');
        }

        function viewAllNotifications() {
            window.location.href = 'announcements.html';
        }

        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.notification-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'login.html';
            }
        }

        function toggleMobileMore() {
            document.getElementById('mobileMoreDropdown').classList.toggle('active');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing household page');
            
            showTab('visitors');
            
            // Add event listeners for family and tenant buttons
            const addFamilyBtn = document.querySelector('button[onclick="openAddFamilyModal()"]');
            if (addFamilyBtn) {
                addFamilyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Family button clicked via event listener');
                    openAddFamilyModal();
                });
                console.log('Family button found and listener added');
            } else {
                console.error('Family button not found');
            }

            const addTenantBtn = document.querySelector('button[onclick="openAddTenantModal()"]');
            if (addTenantBtn) {
                addTenantBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Tenant button clicked via event listener');
                    openAddTenantModal();
                });
                console.log('Tenant button found and listener added');
            } else {
                console.error('Tenant button not found');
            }
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                // Close user menu if clicking outside
                const userMenu = document.getElementById('userMenuModal');
                if (!event.target.closest('.user-avatar') && !event.target.closest('.user-menu-modal')) {
                    userMenu.classList.remove('active');
                }
                
                // Close notification modal if clicking on overlay
                const notificationModal = document.getElementById('notificationModal');
                if (event.target.classList.contains('notification-overlay')) {
                    notificationModal.classList.remove('active');
                }
            });
        });

        // Only close modal when clicking outside modal-content
        window.onclick = function(event) {
            var modals = document.querySelectorAll('.modal');
            modals.forEach(function(modal) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Replace addExpectedVisitor to show QR in a new modal
        function addExpectedVisitor(event) {
            event.preventDefault();
            const name = document.getElementById('visitorName').value;
            const phone = document.getElementById('visitorPhone').value;
            const date = document.getElementById('visitDate').value;
            const time = document.getElementById('visitTime').value;
            const purpose = document.getElementById('visitPurpose').value;
            const notes = document.getElementById('visitNotes').value;
            
            // Add to visitors array as expected
            visitors.push({
                id: Math.max(...visitors.map(v => v.id), 0) + 1,
                name,
                phone,
                email: '',
                date,
                time,
                purpose,
                status: 'expected',
                notes
            });
            loadVisitors();
            // Generate QR code
            const qrData = JSON.stringify({name, phone, date, time, purpose, notes});
            document.getElementById('expectedVisitorModal').style.display = 'none';
            // Show QR in new modal
            document.getElementById('visitorQRCodeDisplay').innerHTML = '';
            new QRCode(document.getElementById('visitorQRCodeDisplay'), {
                text: qrData,
                width: 180,
                height: 180
            });
            document.getElementById('qrVisitorDetailsDisplay').innerText = `${name} | ${date} ${time}`;
            document.getElementById('visitorQRModal').style.display = 'flex';
        }

        function openExpectedVisitorModal() {
            console.log('openExpectedVisitorModal called'); // Debug log
            var modal = document.getElementById('expectedVisitorModal');
            if (modal) {
                document.getElementById('expectedVisitorForm').reset();
                modal.style.display = 'flex';
            } else {
                alert('Modal with id expectedVisitorModal not found!');
            }
        }

        // Download QR code as PNG (for both modals)
        function downloadVisitorQR(qrDivId = 'visitorQRCode') {
            const qrCanvas = document.querySelector(`#${qrDivId} canvas`);
            if (qrCanvas) {
                const link = document.createElement('a');
                link.href = qrCanvas.toDataURL('image/png');
                link.download = 'visitor-qr.png';
                link.click();
            } else {
                alert('QR code not found. Please generate a visitor QR first.');
            }
        }

        // Share QR (for both modals)
        function shareVisitorQR(method, qrDivId = 'visitorQRCode') {
            const qrCanvas = document.querySelector(`#${qrDivId} canvas`);
            const details = qrDivId === 'visitorQRCodeDisplay' ? document.getElementById('qrVisitorDetailsDisplay').innerText : document.getElementById('qrVisitorDetails').innerText;
            let qrDataUrl = '';
            if (qrCanvas) {
                qrDataUrl = qrCanvas.toDataURL('image/png');
            } else {
                alert('QR code not found. Please generate a visitor QR first.');
                return;
            }
            const subject = encodeURIComponent('Your Visitor QR Code');
            const body = encodeURIComponent(`Here is your visitor QR code for access.\n${details}`);
            if (method === 'gmail') {
                const mailto = `mailto:?subject=${subject}&body=${body}%0A%0A(If you cannot see the QR image, download it from the link below:)%0A${qrDataUrl}`;
                window.open(mailto, '_blank');
            } else if (method === 'whatsapp') {
                const text = encodeURIComponent(`Visitor QR for access:\n${details}\n(Download QR image: ${qrDataUrl})`);
                window.open(`https://wa.me/?text=${text}`, '_blank');
            } else if (method === 'messenger') {
                const text = encodeURIComponent(`Visitor QR for access:\n${details}\n(Download QR image: ${qrDataUrl})`);
                window.open(`https://www.facebook.com/dialog/send?app_id=123456789&link=${qrDataUrl}&redirect_uri=${window.location.href}`, '_blank');
            }
        }
    </script>
</body>
</html> 